--// Modern Merchant GUI + Advanced Farming
--// Features: Merchant Auto-Buy, Magnet, Single Farm, Group Farm, Config Saving, Ignore Rares, Event NPC Farm

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

-- Attempt to find the Purchase Remote (Merchant)
local PurchaseRemote = ReplicatedStorage:WaitForChild("NetworkEvents"):WaitForChild("PURCHASE_SHOP_STOCK")

--== FILE SYSTEM ==--
local MAIN_SETTINGS_FILE = "MerchantGUI_Settings.json"
local function getFileName(name) return "MerchantCfg_" .. name .. ".json" end

-- Global Settings (which config to load on start)
local Settings = {
    AutoLoadConfigName = "Default",
    AutoLoadEnabled = true
}

-- Current Active Config (The actual settings)
local Config = {
    FastPets = false,
    -- Merchant
    SelectedItems = {},
    AutoBuyEnabled = false,
    AutoBuyDelay = 1,
    
    -- Farming / Magnet
    InfiniteMagnet = false,
    FarmRange = 300,        -- Default range
    Farm1Enabled = false,   -- Single Farm
    Farm2Enabled = false,   -- Group Farm

    -- NEW SETTINGS:
    FarmCoinsEnabled = false,  -- Target only coins/piles/diamonds
    FarmBushesEnabled = false, -- Target only bushes/plants
    GroupChests = true,        -- true = All pets on one chest; false = 1 pet per chest
    IgnoreRares = false,       -- NEW: Ignore Crystals/Super Candy
    EventNPCEnabled = false,   -- Toggle for Event NPC Farm
    EventBossEnabled = false,  -- Toggle for Event Boss
    ConfigName = "Default"
}


--== ITEM DATA (MERCHANT) ==--
local Items = {
    {display = "Petcoins Potion", key = "items:petcoins_potion", price = 29},
    {display = "EXP Potion", key = "items:exp_potion", price = 29},
    {display = "Sandwich", key = "items:sandwich", price = 29},
    {display = "Superpotion", key = "items:superpotion", price = 29},
    {display = "Bubble Gum", key = "items:bubble_gum", price = 29},
    {display = "Special Mount", key = "items:special_mount", price = 49},
    {display = "Cookies", key = "items:cookies", price = 69},
    {display = "Cake", key = "items:cake", price = 69},
    {display = "Paella", key = "items:paella", price = 99},
    {display = "Gyozas", key = "items:gyozas", price = 99},
    {display = "Legendary Luck", key = "items:legendary_luck", price = 129},
    {display = "Celestial Luck", key = "items:celestial_luck", price = 129},
    {display = "Electric Bicycle", key = "items:electric_bicycle", price = 149000},
    {display = "Shiny Star", key = "items:shiny_star", price = 799},
    {display = "Super Candy", key = "items:super_candy", price = 799},
    {display = "Incense", key = "items:incense", price = 5000},
    {display = "Meteorite", key = "items:meteorite", price = 5000},
    {display = "x2 Celestial Luck!", key = "items:x2_celestial_luck!", price = 1500000},

    -- Stones
    {display = "Dragon Evo Stone", key = "items:dragon_evolution_stone", price = 29},
    {display = "Grass Evo Stone", key = "items:grass_evolution_stone", price = 29},
    {display = "Ground Evo Stone", key = "items:ground_evolution_stone", price = 29},
    {display = "Normal Evo Stone", key = "items:normal_evolution_stone", price = 29},
    {display = "Poison Evo Stone", key = "items:poison_evolution_stone", price = 29},
    {display = "Rock Evo Stone", key = "items:rock_evolution_stone", price = 29},
    {display = "Water Evo Stone", key = "items:water_evolution_stone", price = 29},
    {display = "Psychic Evo Stone",key = "items:psychic_evolution_stone", price = 29},
    {display = "Fairy Evo Stone", key = "items:fairy_evolution_stone", price = 29},
    {display = "Bug Evo Stone", key = "items:bug_evolution_stone", price = 29},
    {display = "Ice Evo Stone", key = "items:ice_evolution_stone", price = 29},
    {display = "Dark Evo Stone", key = "items:dark_evolution_stone", price = 29},
    {display = "Steel Evo Stone", key = "items:steel_evolution_stone", price = 29},
    {display = "Electric Evo Stone", key = "items:electric_evolution_stone", price = 29},
    {display = "Fighting Evo Stone", key = "items:fighting_evolution_stone", price = 29},
    {display = "Fire Evo Stone", key = "items:fire_evolution_stone", price = 29},
    {display = "Flying Evo Stone", key = "items:flying_evolution_stone", price = 29},
    {display = "Ghost Evo Stone", key = "items:ghost_evolution_stone", price = 29},
}

-- Sort into categories
local Categories = { Potions = {}, Foods = {}, Stones = {} }
for _, item in ipairs(Items) do
    local name = item.display:lower()
    if name:find("potion") or name:find("luck") or name:find("candy") or name:find("incense") or name:find("meteorite") or name:find("star") then
        table.insert(Categories.Potions, item)
    elseif name:find("sandwich") or name:find("bubble gum") or name:find("cookies") or name:find("cake") or name:find("paella") or name:find("gyozas") then
        table.insert(Categories.Foods, item)
    elseif name:find("evo stone") or name:find("stone") then
        table.insert(Categories.Stones, item)
    else
        table.insert(Categories.Potions, item)
    end
end

--== IO FUNCTIONS ==--
local function saveMainSettings()
    if writefile then writefile(MAIN_SETTINGS_FILE, HttpService:JSONEncode(Settings)) end
end

local function loadMainSettings()
    if isfile and isfile(MAIN_SETTINGS_FILE) then
        local s, r = pcall(function() return HttpService:JSONDecode(readfile(MAIN_SETTINGS_FILE)) end)
        if s and type(r) == "table" then
            for k,v in pairs(r) do Settings[k] = v end
        end
    end
end

local function saveConfig(name)
    local data = {
        SelectedItems = Config.SelectedItems,
        AutoBuyEnabled = Config.AutoBuyEnabled,
        AutoBuyDelay = Config.AutoBuyDelay,
        InfiniteMagnet = Config.InfiniteMagnet,
        
        -- NEW Save Farming Configs
        FarmRange = Config.FarmRange,
        Farm1Enabled = Config.Farm1Enabled,
        Farm2Enabled = Config.Farm2Enabled,
        
        -- FILTERS
        FarmCoinsEnabled = Config.FarmCoinsEnabled,
        FarmBushesEnabled = Config.FarmBushesEnabled,
        GroupChests = Config.GroupChests,
        IgnoreRares = Config.IgnoreRares, -- NEW
        EventNPCEnabled = Config.EventNPCEnabled,
        EventBossEnabled = Config.EventBossEnabled,
        ConfigName = name
    }
    
    if writefile then
        writefile(getFileName(name), HttpService:JSONEncode(data))
    end
end

local function loadConfig(name)
    local fname = getFileName(name)
    if isfile and isfile(fname) then
        local s, r = pcall(function() return HttpService:JSONDecode(readfile(fname)) end)
        if s and type(r) == "table" then
            Config.SelectedItems = r.SelectedItems or {}
            Config.AutoBuyEnabled = r.AutoBuyEnabled or false
            Config.AutoBuyDelay = r.AutoBuyDelay or 1
            Config.InfiniteMagnet = r.InfiniteMagnet or false
            
            -- [NEW] Load Farming Configs
            Config.FarmRange = r.FarmRange or 300
            Config.Farm1Enabled = r.Farm1Enabled or false
            Config.Farm2Enabled = r.Farm2Enabled or false
            Config.FarmCoinsEnabled = r.FarmCoinsEnabled or false
            Config.FarmBushesEnabled = r.FarmBushesEnabled or false
            Config.IgnoreRares = r.IgnoreRares or false -- NEW
            Config.EventNPCEnabled = r.EventNPCEnabled or false
            Config.EventBossEnabled = r.EventBossEnabled or false

            -- Special check for GroupChests to default to TRUE if nil (for old configs)
            if r.GroupChests ~= nil then
                Config.GroupChests = r.GroupChests
            else
                Config.GroupChests = true 
            end

            Config.ConfigName = name
            return true
        end
    end
    return false
end

local function deleteConfig(name)
    local fname = getFileName(name)
    if isfile and isfile(fname) and delfile then
        delfile(fname)
        return true
    end
    return false
end

local function listConfigs()
    local list = {"Default"}
    if listfiles then
        for _, file in ipairs(listfiles("")) do
            if file:find("MerchantCfg_") and file:find(".json") then
                local n = file:match("MerchantCfg_(.+)%.json")
                if n and n ~= "Default" then table.insert(list, n) end
            end
        end
    end
    return list
end

-- Initial Load
loadMainSettings()
if Settings.AutoLoadEnabled then
    loadConfig(Settings.AutoLoadConfigName)
end

--== UI HELPERS ==--
local function create(class, props, children)
    local inst = Instance.new(class)
    for k,v in pairs(props) do inst[k] = v end
    if children then for _,c in pairs(children) do c.Parent = inst end end
    return inst
end

local C_BG = Color3.fromRGB(24, 24, 27)
local C_MAIN = Color3.fromRGB(31, 31, 35)
local C_ACCENT = Color3.fromRGB(50, 50, 60)
local C_TEXT = Color3.fromRGB(220, 220, 220)
local C_TEXT_DIM = Color3.fromRGB(160, 160, 170)
local C_GREEN = Color3.fromRGB(100, 200, 100)
local C_RED = Color3.fromRGB(200, 80, 80)
local C_BLUE = Color3.fromRGB(80, 140, 220)

-- Tooltip logic
local TooltipLabel
local function addTooltip(obj, text)
    obj.MouseEnter:Connect(function()
        if not TooltipLabel then return end
        TooltipLabel.Text = text
        TooltipLabel.Visible = true
    end)
    obj.MouseLeave:Connect(function()
        if TooltipLabel then TooltipLabel.Visible = false end
    end)
    obj.MouseMoved:Connect(function(x, y)
        if TooltipLabel then
            TooltipLabel.Position = UDim2.new(0, x + 15, 0, y + 15)
        end
    end)
end

--== MAIN GUI ==--
local ScreenGui = create("ScreenGui", { Name = "MerchantUltimate", Parent = LocalPlayer:WaitForChild("PlayerGui"), ResetOnSpawn = false, DisplayOrder = 100 })

TooltipLabel = create("TextLabel", {
    Parent = ScreenGui, Visible = false, ZIndex = 200, BackgroundColor3 = C_BG, TextColor3 = C_TEXT,
    Size = UDim2.new(0, 0, 0, 0), AutomaticSize = Enum.AutomaticSize.XY, Font = Enum.Font.Code, TextSize = 12,
    BorderSizePixel = 0
}, { create("UICorner", {CornerRadius = UDim.new(0, 4)}), create("UIPadding", {PaddingTop=UDim.new(0,4), PaddingBottom=UDim.new(0,4), PaddingLeft=UDim.new(0,6), PaddingRight=UDim.new(0,6)}) })

local MainFrame = create("Frame", {
    Name = "MainFrame", Size = UDim2.new(0, 360, 0, 500), Position = UDim2.new(0.5, -180, 0.5, -250),
    BackgroundColor3 = C_BG, Parent = ScreenGui, ClipsDescendants = true
}, { create("UICorner", {CornerRadius = UDim.new(0, 8)}), create("UIStroke", {Color = C_ACCENT}) })

-- Dragging
local dragging, dragStart, startPos
MainFrame.InputBegan:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then dragging = true; dragStart = i.Position; startPos = MainFrame.Position end end)
UserInputService.InputChanged:Connect(function(i) if dragging and i.UserInputType == Enum.UserInputType.MouseMovement then local d = i.Position - dragStart; MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + d.X, startPos.Y.Scale, startPos.Y.Offset + d.Y) end end)
UserInputService.InputEnded:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end end)
UserInputService.InputBegan:Connect(function(i,g) if not g and i.KeyCode == Enum.KeyCode.LeftControl then MainFrame.Visible = not MainFrame.Visible end end)

-- Header
local TopBar = create("Frame", { Size = UDim2.new(1, 0, 0, 32), BackgroundTransparency = 1, Parent = MainFrame })
create("TextLabel", { Parent = TopBar, Text = " GLUM HUB", Font = Enum.Font.GothamBold, TextSize = 12, TextColor3 = C_TEXT, Size = UDim2.new(1, -40, 1, 0), BackgroundTransparency = 1, TextXAlignment = Enum.TextXAlignment.Left })
local CloseBtn = create("TextButton", { Parent = TopBar, Text = "X", Font = Enum.Font.GothamBold, TextColor3 = C_RED, Size = UDim2.new(0, 32, 0, 32), Position = UDim2.new(1, -32, 0, 0), BackgroundTransparency = 1 })
CloseBtn.MouseButton1Click:Connect(function() ScreenGui:Destroy() end)

-- Tab Buttons
local TabContainer = create("Frame", { Size = UDim2.new(1, -16, 0, 30), Position = UDim2.new(0, 8, 0, 32), BackgroundColor3 = C_MAIN, Parent = MainFrame }, { create("UICorner", {CornerRadius = UDim.new(0, 6)}) })
local MerchantBtn = create("TextButton", { Parent = TabContainer, Size = UDim2.new(0.333, 0, 1, 0), BackgroundTransparency = 1, Text = "Merchant", Font = Enum.Font.GothamMedium, TextColor3 = C_TEXT, TextSize = 13 })
local FarmingBtn = create("TextButton", { Parent = TabContainer, Size = UDim2.new(0.333, 0, 1, 0), Position = UDim2.new(0.333, 0, 0, 0), BackgroundTransparency = 1, Text = "Farming", Font = Enum.Font.GothamMedium, TextColor3 = C_TEXT_DIM, TextSize = 13 })
local ConfigBtn = create("TextButton", { Parent = TabContainer, Size = UDim2.new(0.333, 0, 1, 0), Position = UDim2.new(0.666, 0, 0, 0), BackgroundTransparency = 1, Text = "Config", Font = Enum.Font.GothamMedium, TextColor3 = C_TEXT_DIM, TextSize = 13 })
local Indicator = create("Frame", { Parent = TabContainer, Size = UDim2.new(0.333, -4, 0, 2), Position = UDim2.new(0, 2, 1, -2), BackgroundColor3 = C_GREEN, BorderSizePixel = 0 })

-- Pages
local PageContainer = create("Frame", { Size = UDim2.new(1, -16, 1, -74), Position = UDim2.new(0, 8, 0, 70), BackgroundTransparency = 1, Parent = MainFrame })
local MerchantPage = create("ScrollingFrame", { Parent = PageContainer, Size = UDim2.new(1, 0, 1, 0), BackgroundTransparency = 1, ScrollBarThickness = 2, ScrollBarImageColor3 = C_ACCENT, AutomaticCanvasSize = Enum.AutomaticSize.Y, CanvasSize = UDim2.new(0,0,0,0) })
local FarmingPage = create("ScrollingFrame", { Parent = PageContainer, Size = UDim2.new(1, 0, 1, 0), BackgroundTransparency = 1, Visible = false, AutomaticCanvasSize = Enum.AutomaticSize.Y, CanvasSize = UDim2.new(0,0,0,0), ScrollBarThickness = 2, ScrollBarImageColor3 = C_ACCENT })
local ConfigPage = create("ScrollingFrame", { Parent = PageContainer, Size = UDim2.new(1, 0, 1, 0), BackgroundTransparency = 1, Visible = false, AutomaticCanvasSize = Enum.AutomaticSize.Y, CanvasSize = UDim2.new(0,0,0,0), ScrollBarThickness = 2, ScrollBarImageColor3 = C_ACCENT })

create("UIListLayout", { Parent = MerchantPage, SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0, 8) })
create("UIPadding", { Parent = MerchantPage, PaddingRight = UDim.new(0, 4) })

create("UIListLayout", { Parent = FarmingPage, SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0, 8) })
create("UIPadding", { Parent = FarmingPage, PaddingRight = UDim.new(0, 4) })

create("UIListLayout", { Parent = ConfigPage, SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0, 8) })

-- Switch Tabs
MerchantBtn.MouseButton1Click:Connect(function()
    MerchantPage.Visible = true; FarmingPage.Visible = false; ConfigPage.Visible = false
    MerchantBtn.TextColor3 = C_TEXT; FarmingBtn.TextColor3 = C_TEXT_DIM; ConfigBtn.TextColor3 = C_TEXT_DIM
    Indicator:TweenPosition(UDim2.new(0, 2, 1, -2), "Out", "Quad", 0.2)
end)
FarmingBtn.MouseButton1Click:Connect(function()
    MerchantPage.Visible = false; FarmingPage.Visible = true; ConfigPage.Visible = false
    MerchantBtn.TextColor3 = C_TEXT_DIM; FarmingBtn.TextColor3 = C_TEXT; ConfigBtn.TextColor3 = C_TEXT_DIM
    Indicator:TweenPosition(UDim2.new(0.333, 2, 1, -2), "Out", "Quad", 0.2)
end)
ConfigBtn.MouseButton1Click:Connect(function()
    MerchantPage.Visible = false; FarmingPage.Visible = false; ConfigPage.Visible = true
    MerchantBtn.TextColor3 = C_TEXT_DIM; FarmingBtn.TextColor3 = C_TEXT_DIM; ConfigBtn.TextColor3 = C_TEXT
    Indicator:TweenPosition(UDim2.new(0.666, 2, 1, -2), "Out", "Quad", 0.2)
end)

--== FARMING PAGE LOGIC ==--

-- 1. MAGNET SECTION (FIXED UI)
local MagnetPanel = create("Frame", { Parent = FarmingPage, Size = UDim2.new(1, 0, 0, 60), BackgroundColor3 = C_MAIN }, { create("UICorner", {CornerRadius = UDim.new(0, 6)}), create("UIStroke", {Color = C_ACCENT}) })
create("TextLabel", { Parent = MagnetPanel, Text = "Magnet Collection", Font = Enum.Font.GothamBold, TextSize = 12, TextColor3 = C_TEXT_DIM, Size = UDim2.new(1, -20, 0, 20), Position = UDim2.new(0, 10, 0, 5), BackgroundTransparency = 1, TextXAlignment = Enum.TextXAlignment.Left })
local MagnetBtn = create("TextButton", {
    Parent = MagnetPanel, Size = UDim2.new(1, -20, 0, 26), Position = UDim2.new(0, 10, 0, 28),
    BackgroundColor3 = C_ACCENT, Text = "Enable Infinite Magnet", Font = Enum.Font.GothamBold, TextSize = 12, TextColor3 = C_TEXT
}, { create("UICorner", {CornerRadius = UDim.new(0, 4)}) })

local magnetConnections = {}
local magnetListener = nil

local function SetMagnetState(state)
    Config.InfiniteMagnet = state
    if state then
        MagnetBtn.Text = "Magnet Active"
        MagnetBtn.TextColor3 = C_GREEN
        MagnetBtn.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
        
        local orbFolder = workspace:WaitForChild("Orbs")
        local function magnet(orb)
            if not Config.InfiniteMagnet then return end
            local part = orb:IsA("Model") and (orb.PrimaryPart or orb:FindFirstChildWhichIsA("BasePart")) or orb:IsA("BasePart") and orb
            if not part then return end
            part.Transparency = 1; part.CanCollide = false; part.CastShadow = false; part.Anchored = true
            
            local connection
            connection = RunService.Heartbeat:Connect(function()
                if not Config.InfiniteMagnet then if connection then connection:Disconnect() end return end
                if not part.Parent or not LocalPlayer.Character then connection:Disconnect() return end
                local root = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                if root then part.CFrame = root.CFrame end
            end)
            table.insert(magnetConnections, connection)
        end
        
        for _, orb in pairs(orbFolder:GetChildren()) do magnet(orb) end
        magnetListener = orbFolder.ChildAdded:Connect(function(orb) task.wait(); if Config.InfiniteMagnet then magnet(orb) end end)
    else
        MagnetBtn.Text = "Enable Infinite Magnet"
        MagnetBtn.TextColor3 = C_TEXT
        MagnetBtn.BackgroundColor3 = C_ACCENT
        if magnetListener then magnetListener:Disconnect() magnetListener = nil end
        for _, conn in pairs(magnetConnections) do if conn then conn:Disconnect() end end
        magnetConnections = {}
    end
end

MagnetBtn.MouseButton1Click:Connect(function() SetMagnetState(not Config.InfiniteMagnet) end)

local SpeedBtn = create("TextButton", {
    Parent = MagnetPanel, Size = UDim2.new(0, 100, 0, 20), Position = UDim2.new(1, -110, 0, 5),
    BackgroundColor3 = C_ACCENT, Text = "Fast Pets: OFF", Font = Enum.Font.GothamBold, TextSize = 10, TextColor3 = C_TEXT
}, { create("UICorner", {CornerRadius = UDim.new(0, 4)}) })
addTooltip(SpeedBtn, "Set speed_multiplier to 20x")

SpeedBtn.MouseButton1Click:Connect(function()
    Config.FastPets = not Config.FastPets
    SpeedBtn.Text = Config.FastPets and "Fast Pets: ON" or "Fast Pets: OFF"
    SpeedBtn.TextColor3 = Config.FastPets and C_GREEN or C_TEXT
end)

if Config.InfiniteMagnet then SetMagnetState(true) end

-- 2. RANGE SETTING
local RangePanel = create("Frame", { Parent = FarmingPage, Size = UDim2.new(1, 0, 0, 60), BackgroundColor3 = C_MAIN }, { create("UICorner", {CornerRadius = UDim.new(0, 6)}), create("UIStroke", {Color = C_ACCENT}) })
create("TextLabel", { Parent = RangePanel, Text = "Farm Range (50-900)", Font = Enum.Font.GothamBold, TextSize = 12, TextColor3 = C_TEXT_DIM, Size = UDim2.new(1, -20, 0, 20), Position = UDim2.new(0, 10, 0, 5), BackgroundTransparency = 1, TextXAlignment = Enum.TextXAlignment.Left })
local RangeInput = create("TextBox", {
    Parent = RangePanel, Size = UDim2.new(1, -110, 0, 26), Position = UDim2.new(0, 10, 0, 28),
    BackgroundColor3 = C_BG, Text = tostring(Config.FarmRange), TextColor3 = C_BLUE, Font = Enum.Font.Code, TextSize = 13
}, { create("UICorner", {CornerRadius = UDim.new(0, 4)}), create("UIStroke", {Color = C_ACCENT}) })
addTooltip(RangeInput, "Set the detection range for auto farming")

RangeInput.FocusLost:Connect(function()
    local n = tonumber(RangeInput.Text)
    if n then
        n = math.clamp(n, 50, 900)
        Config.FarmRange = n
    else
        Config.FarmRange = 300
    end
    
    RangeInput.Text = tostring(Config.FarmRange)
end)
local VisualRangeBtn = create("TextButton", { Parent = RangePanel, Size = UDim2.new(0, 80, 0, 26), Position = UDim2.new(1, -90, 0, 28), BackgroundColor3 = C_ACCENT, Text = "Visual: OFF", Font = Enum.Font.GothamBold, TextSize = 10, TextColor3 = C_TEXT }, { create("UICorner", {CornerRadius = UDim.new(0, 4)}) })
local VisualPart = nil
local VisualConnection = nil
local function toggleVisualRange(state)
    if state == nil then state = not Config.VisualRangeEnabled end
    Config.VisualRangeEnabled = state
    VisualRangeBtn.Text = Config.VisualRangeEnabled and "Visual: ON" or "Visual: OFF"
    VisualRangeBtn.TextColor3 = Config.VisualRangeEnabled and C_GREEN or C_TEXT
    if Config.VisualRangeEnabled then
        if not VisualPart then
            VisualPart = Instance.new("Part"); VisualPart.Name = "FarmRangeVisual"; VisualPart.Shape = Enum.PartType.Cylinder; VisualPart.Color = Color3.fromRGB(125, 0, 255); VisualPart.Transparency = 0.85; VisualPart.Material = Enum.Material.Neon; VisualPart.Anchored = true; VisualPart.CanCollide = false; VisualPart.CastShadow = false; VisualPart.Parent = workspace
        end
        if VisualConnection then VisualConnection:Disconnect() end
        VisualConnection = RunService.RenderStepped:Connect(function()
            if VisualPart and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                local root = LocalPlayer.Character.HumanoidRootPart; local r = Config.FarmRange or 300
                VisualPart.Size = Vector3.new(1, r*2, r*2); VisualPart.CFrame = root.CFrame * CFrame.fromEulerAnglesXYZ(0, 0, math.rad(90))
            end
        end)
    else
        if VisualPart then VisualPart:Destroy(); VisualPart = nil end
        if VisualConnection then VisualConnection:Disconnect(); VisualConnection = nil end
    end
end
VisualRangeBtn.MouseButton1Click:Connect(function() toggleVisualRange() end)


local updateFarmButtons -- This tells the script "this function is coming later"

-- 2.5 FILTERS & SETTINGS
-- Increased height for the new button
local FilterPanel = create("Frame", { Parent = FarmingPage, Size = UDim2.new(1, 0, 0, 207), BackgroundColor3 = C_MAIN }, { create("UICorner", {CornerRadius = UDim.new(0, 6)}), create("UIStroke", {Color = C_ACCENT}) })
create("TextLabel", { Parent = FilterPanel, Text = "Target Filter", Font = Enum.Font.GothamBold, TextSize = 12, TextColor3 = C_TEXT_DIM, Size = UDim2.new(1, -20, 0, 20), Position = UDim2.new(0, 10, 0, 5), BackgroundTransparency = 1, TextXAlignment = Enum.TextXAlignment.Left })

-- 1. Default Button (Top)
local DefaultBtn = create("TextButton", { Parent = FilterPanel, Size = UDim2.new(1, -20, 0, 24), Position = UDim2.new(0, 10, 0, 28), BackgroundColor3 = C_ACCENT, Text = "Default (Target All)", Font = Enum.Font.GothamBold, TextSize = 11, TextColor3 = C_TEXT }, { create("UICorner", {CornerRadius = UDim.new(0, 4)}) })

-- 2. Coins & Bushes (Middle Row)
local CoinsBtn = create("TextButton", { Parent = FilterPanel, Size = UDim2.new(0.5, -14, 0, 24), Position = UDim2.new(0, 10, 0, 56), BackgroundColor3 = C_ACCENT, Text = "Coins Only", Font = Enum.Font.GothamBold, TextSize = 11, TextColor3 = C_TEXT }, { create("UICorner", {CornerRadius = UDim.new(0, 4)}) })
local BushesBtn = create("TextButton", { Parent = FilterPanel, Size = UDim2.new(0.5, -14, 0, 24), Position = UDim2.new(0.5, 4, 0, 56), BackgroundColor3 = C_ACCENT, Text = "Bushes Only", Font = Enum.Font.GothamBold, TextSize = 11, TextColor3 = C_TEXT }, { create("UICorner", {CornerRadius = UDim.new(0, 4)}) })

-- 3. Focus on breakables
local GroupChestBtn = create("TextButton", { Parent = FilterPanel, Size = UDim2.new(1, -20, 0, 24), Position = UDim2.new(0, 10, 0, 88), BackgroundColor3 = C_ACCENT, Text = "Focus Pets On Chests & PetBalls: ON", Font = Enum.Font.GothamBold, TextSize = 11, TextColor3 = C_TEXT }, { create("UICorner", {CornerRadius = UDim.new(0, 4)}) })
addTooltip(GroupChestBtn, "ON: All of your pets rush to petballs & chests. OFF: Pets target closest breakables.")

-- 4. IGNORE RARES (NEW)
local IgnoreRaresBtn = create("TextButton", { Parent = FilterPanel, Size = UDim2.new(1, -20, 0, 24), Position = UDim2.new(0, 10, 0, 116), BackgroundColor3 = C_ACCENT, Text = "Ignore Crystals & Super Candy: OFF", Font = Enum.Font.GothamBold, TextSize = 11, TextColor3 = C_TEXT }, { create("UICorner", {CornerRadius = UDim.new(0, 4)}) })

addTooltip(IgnoreRaresBtn, "When ON, pets will not target Crystals or Super Candy.")

-- 5. EVENT NPC FARM (NEW)
local EventNPCBtn = create("TextButton", { Parent = FilterPanel, Size = UDim2.new(1, -20, 0, 24), Position = UDim2.new(0, 10, 0, 144), BackgroundColor3 = C_ACCENT, Text = "Event NPC Farm: OFF", Font = Enum.Font.GothamBold, TextSize = 11, TextColor3 = C_TEXT }, { create("UICorner", {CornerRadius = UDim.new(0, 4)}) })
addTooltip(EventNPCBtn, "Targets Christmas NPCs (Thistling, Shooba, Stegrump).")

local EventBossBtn = create("TextButton", { Parent = FilterPanel, Size = UDim2.new(1, -20, 0, 24), Position = UDim2.new(0, 10, 0, 172), BackgroundColor3 = C_ACCENT, Text = "Include Event Boss: OFF", Font = Enum.Font.GothamBold, TextSize = 11, TextColor3 = C_TEXT }, { create("UICorner", {CornerRadius = UDim.new(0, 4)}) })
addTooltip(EventBossBtn, "Also target the Event Boss (Ice1) if Event NPC Farm is ON.")

EventNPCBtn.MouseButton1Click:Connect(function()
    Config.EventNPCEnabled = not Config.EventNPCEnabled
    if Config.EventNPCEnabled then
        Config.FarmCoinsEnabled = false
        Config.FarmBushesEnabled = false
    else
        Config.EventBossEnabled = false
    end
    updateFarmButtons()
end)

EventBossBtn.MouseButton1Click:Connect(function()
    Config.EventBossEnabled = not Config.EventBossEnabled
    if Config.EventBossEnabled then
        Config.EventNPCEnabled = true
        Config.FarmCoinsEnabled = false
        Config.FarmBushesEnabled = false
    end
    updateFarmButtons()
end)

-- Logic: "Radio Button" style. Clicking one disables the others.

DefaultBtn.MouseButton1Click:Connect(function()
    Config.FarmCoinsEnabled = false
    Config.FarmBushesEnabled = false
    Config.EventNPCEnabled = false
    Config.EventBossEnabled = false
    updateFarmButtons()
end)

CoinsBtn.MouseButton1Click:Connect(function()
    Config.FarmCoinsEnabled = not Config.FarmCoinsEnabled
    if Config.FarmCoinsEnabled then
        Config.FarmBushesEnabled = false
        Config.EventNPCEnabled = false
        Config.EventBossEnabled = false
    end
    updateFarmButtons()
end)

BushesBtn.MouseButton1Click:Connect(function()
    Config.FarmBushesEnabled = not Config.FarmBushesEnabled
    if Config.FarmBushesEnabled then
        Config.FarmCoinsEnabled = false
        Config.EventNPCEnabled = false
        Config.EventBossEnabled = false
    end
    updateFarmButtons()
end)

GroupChestBtn.MouseButton1Click:Connect(function()
    Config.GroupChests = not Config.GroupChests
    updateFarmButtons()
end)

IgnoreRaresBtn.MouseButton1Click:Connect(function()
    Config.IgnoreRares = not Config.IgnoreRares
    updateFarmButtons()
end)

-- 3. FARM TOGGLES (RENAMED)
local Farm1Btn = create("TextButton", {
    Parent = FarmingPage, Size = UDim2.new(1, 0, 0, 40), BackgroundColor3 = C_ACCENT,
    Text = "Single Farm (1 Pet/Coin)", Font = Enum.Font.GothamBold, TextSize = 12, TextColor3 = C_TEXT
}, { create("UICorner", {CornerRadius = UDim.new(0, 6)}) })
addTooltip(Farm1Btn, "Sends 3 pets to chests/balls, if none found then sends 1 pet to each different low tier breakable")

local Farm2Btn = create("TextButton", {
    Parent = FarmingPage, Size = UDim2.new(1, 0, 0, 40), BackgroundColor3 = C_ACCENT,
    Text = "Group Farm (ALL)", Font = Enum.Font.GothamBold, TextSize = 12, TextColor3 = C_TEXT
}, { create("UICorner", {CornerRadius = UDim.new(0, 6)}) })
addTooltip(Farm2Btn, "Sends ALL pets to the nearest breakable.")

updateFarmButtons = function()
    -- Original Main Buttons
    if Config.Farm1Enabled then
        Farm1Btn.Text = "Single Farm ACTIVE"
        Farm1Btn.TextColor3 = C_GREEN
        Farm1Btn.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    else
        Farm1Btn.Text = "Single Farm (Start)"
        Farm1Btn.TextColor3 = C_TEXT
        Farm1Btn.BackgroundColor3 = C_ACCENT
    end
    
    if Config.Farm2Enabled then
        Farm2Btn.Text = "Group Farm ACTIVE"
        Farm2Btn.TextColor3 = C_GREEN
        Farm2Btn.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    else
        Farm2Btn.Text = "Group Farm (Start)"
        Farm2Btn.TextColor3 = C_TEXT
        Farm2Btn.BackgroundColor3 = C_ACCENT
    end
    
    -- Filter Buttons Logic (Radio Style)
    local isCoins = Config.FarmCoinsEnabled
    local isBushes = Config.FarmBushesEnabled
    local isDefault = (not isCoins and not isBushes and not Config.EventNPCEnabled) -- If all are off, Default is ON
    
    -- 1. Default Button
    if isDefault then
        DefaultBtn.BackgroundColor3 = C_GREEN
        DefaultBtn.TextColor3 = Color3.fromRGB(40, 40, 40)
    else
        DefaultBtn.BackgroundColor3 = C_ACCENT
        DefaultBtn.TextColor3 = C_TEXT
    end
    
    -- 2. Coins Button
    if isCoins then
        CoinsBtn.BackgroundColor3 = C_GREEN
        CoinsBtn.TextColor3 = Color3.fromRGB(40, 40, 40)
    else
        CoinsBtn.BackgroundColor3 = C_ACCENT
        CoinsBtn.TextColor3 = C_TEXT
    end
    
    -- 3. Bushes Button
    if isBushes then
        BushesBtn.BackgroundColor3 = C_GREEN
        BushesBtn.TextColor3 = Color3.fromRGB(40, 40, 40)
    else
        BushesBtn.BackgroundColor3 = C_ACCENT
        BushesBtn.TextColor3 = C_TEXT
    end
    
    -- 4. Group Chests
    if Config.GroupChests then
        GroupChestBtn.Text = "Group Chests: ON"
        GroupChestBtn.TextColor3 = C_GREEN
    else
        GroupChestBtn.Text = "Group Chests: OFF"
        GroupChestBtn.TextColor3 = C_RED
    end
    
    -- 5. Ignore Rares
    if Config.IgnoreRares then
        IgnoreRaresBtn.Text = "Ignore Crystals & Super Candy: ON"
        IgnoreRaresBtn.TextColor3 = C_GREEN
    else
        IgnoreRaresBtn.Text = "Ignore Crystals & Super Candy: OFF"
        IgnoreRaresBtn.TextColor3 = C_RED
    end

    -- Event NPC
    if Config.EventNPCEnabled then
        EventNPCBtn.Text = "Event NPC Farm: ON"
        EventNPCBtn.TextColor3 = C_GREEN
        EventNPCBtn.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    else
        EventNPCBtn.Text = "Event NPC Farm: OFF"
        EventNPCBtn.TextColor3 = C_TEXT
        EventNPCBtn.BackgroundColor3 = C_ACCENT
    end

    if Config.EventBossEnabled then
        EventBossBtn.Text = "Include Event Boss: ON"
        EventBossBtn.TextColor3 = C_GREEN
    else
        EventBossBtn.Text = "Include Event Boss: OFF"
        EventBossBtn.TextColor3 = C_RED
    end
end
Farm1Btn.MouseButton1Click:Connect(function()
    Config.Farm1Enabled = not Config.Farm1Enabled
    if Config.Farm1Enabled then Config.Farm2Enabled = false end -- Disable other
    updateFarmButtons()
end)
Farm2Btn.MouseButton1Click:Connect(function()
    Config.Farm2Enabled = not Config.Farm2Enabled
    if Config.Farm2Enabled then Config.Farm1Enabled = false end -- Disable other
    updateFarmButtons()
end)
updateFarmButtons() -- Init state

--== MERCHANT PAGE LOGIC ==--
local function createCategory(name, items, order)
    local Wrapper = create("Frame", { Parent = MerchantPage, Size = UDim2.new(1, 0, 0, 36), BackgroundColor3 = C_MAIN, LayoutOrder = order, ClipsDescendants = true }, { create("UICorner", {CornerRadius = UDim.new(0, 6)}), create("UIStroke", {Color = C_ACCENT}) })
    local Header = create("TextButton", { Parent = Wrapper, Size = UDim2.new(1, 0, 0, 36), BackgroundTransparency = 1, Text = "", ZIndex = 2 })
    create("TextLabel", { Parent = Header, Text = name, Font = Enum.Font.GothamBold, TextSize = 13, TextColor3 = C_TEXT, Size = UDim2.new(1, -90, 1, 0), Position = UDim2.new(0, 12, 0, 0), BackgroundTransparency = 1, TextXAlignment = Enum.TextXAlignment.Left })
    local Arrow = create("TextLabel", { Parent = Header, Text = "+", Font = Enum.Font.GothamBold, TextSize = 18, TextColor3 = C_TEXT_DIM, Size = UDim2.new(0, 30, 1, 0), Position = UDim2.new(1, -30, 0, 0), BackgroundTransparency = 1 })
    local SelectAllBtn = create("TextButton", { Parent = Header, Size = UDim2.new(0, 60, 0, 20), Position = UDim2.new(1, -100, 0, 8), BackgroundColor3 = C_ACCENT, Text = "Select All", Font = Enum.Font.Gotham, TextSize = 10, TextColor3 = C_TEXT, ZIndex = 3 }, { create("UICorner", {CornerRadius = UDim.new(0, 4)}) })
    addTooltip(SelectAllBtn, "Toggle all items in this category")

    local ItemContainer = create("Frame", { Parent = Wrapper, Size = UDim2.new(1, -16, 0, 0), Position = UDim2.new(0, 8, 0, 36), BackgroundTransparency = 1, AutomaticSize = Enum.AutomaticSize.Y })
    local List = create("UIListLayout", { Parent = ItemContainer, SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0, 4) })
    
    local itemToggles = {}
    for _, item in ipairs(items) do
        local row = create("Frame", { Parent = ItemContainer, Size = UDim2.new(1, 0, 0, 24), BackgroundColor3 = C_BG }, { create("UICorner", {CornerRadius = UDim.new(0, 4)}) })
        local check = create("TextButton", { Parent = row, Size = UDim2.new(0, 24, 0, 24), BackgroundTransparency = 1, Text = "âœ”", Font = Enum.Font.GothamBold, TextSize = 14, TextColor3 = C_GREEN })
        local box = create("Frame", { Parent = check, Size = UDim2.new(0, 14, 0, 14), Position = UDim2.new(0.5, -7, 0.5, -7), BackgroundColor3 = C_MAIN, BorderColor3 = C_TEXT_DIM, BorderSizePixel = 1 })
        
        local function updateCheck() box.BackgroundColor3 = Config.SelectedItems[item.key] and C_GREEN or C_MAIN end
        updateCheck()
        itemToggles[item.key] = updateCheck
        check.MouseButton1Click:Connect(function() Config.SelectedItems[item.key] = not Config.SelectedItems[item.key]; updateCheck() end)
        create("TextLabel", { Parent = row, Size = UDim2.new(1, -30, 1, 0), Position = UDim2.new(0, 30, 0, 0), BackgroundTransparency = 1, Text = item.display .. " [$" .. item.price .. "]", Font = Enum.Font.Gotham, TextSize = 12, TextColor3 = C_TEXT_DIM, TextXAlignment = Enum.TextXAlignment.Left })
    end
    
    SelectAllBtn.MouseButton1Click:Connect(function()
        local allSelected = true
        for _, item in ipairs(items) do if not Config.SelectedItems[item.key] then allSelected = false break end end
        for _, item in ipairs(items) do Config.SelectedItems[item.key] = not allSelected; if itemToggles[item.key] then itemToggles[item.key]() end end
    end)
    
    local expanded = false
    Header.MouseButton1Click:Connect(function()
        expanded = not expanded
        Arrow.Text = expanded and "-" or "+"
        local h = expanded and (List.AbsoluteContentSize.Y + 44) or 36
        TweenService:Create(Wrapper, TweenInfo.new(0.3, Enum.EasingStyle.Quad), {Size = UDim2.new(1, 0, 0, h)}):Play()
    end)
end

createCategory("Potions & Utility", Categories.Potions, 1)
createCategory("Food Items", Categories.Foods, 2)
createCategory("Evolution Stones", Categories.Stones, 3)

local AutoBuyPanel = create("Frame", { Parent = MerchantPage, LayoutOrder = 10, Size = UDim2.new(1, 0, 0, 60), BackgroundColor3 = C_MAIN }, { create("UICorner", {CornerRadius = UDim.new(0, 6)}), create("UIStroke", {Color = C_ACCENT}) })
local ToggleBtn = create("TextButton", { Parent = AutoBuyPanel, Size = UDim2.new(0, 120, 0, 32), Position = UDim2.new(0, 12, 0, 14), BackgroundColor3 = C_RED, Text = "AUTO BUY: OFF", Font = Enum.Font.GothamBold, TextColor3 = C_TEXT, TextSize = 12 }, { create("UICorner", {CornerRadius = UDim.new(0, 4)}) })
local function updateMasterToggle() ToggleBtn.Text = "AUTO BUY: " .. (Config.AutoBuyEnabled and "ON" or "OFF"); ToggleBtn.BackgroundColor3 = Config.AutoBuyEnabled and C_GREEN or C_RED end
updateMasterToggle()
ToggleBtn.MouseButton1Click:Connect(function() Config.AutoBuyEnabled = not Config.AutoBuyEnabled; updateMasterToggle() end)

local DelayInput = create("TextBox", { Parent = AutoBuyPanel, Size = UDim2.new(0, 50, 0, 30), Position = UDim2.new(1, -62, 0, 15), BackgroundColor3 = C_BG, Text = tostring(Config.AutoBuyDelay), TextColor3 = C_TEXT, Font = Enum.Font.Gotham, TextSize = 12 }, { create("UICorner", {CornerRadius = UDim.new(0, 4)}), create("UIStroke", {Color = C_ACCENT}) })
create("TextLabel", { Parent = AutoBuyPanel, Text = "Delay (s):", Position = UDim2.new(1, -130, 0, 15), Size = UDim2.new(0, 60, 0, 30), BackgroundTransparency = 1, TextColor3 = C_TEXT_DIM, Font = Enum.Font.Gotham, TextSize = 12 })
DelayInput.FocusLost:Connect(function() local n = tonumber(DelayInput.Text); if n then Config.AutoBuyDelay = n else DelayInput.Text = tostring(Config.AutoBuyDelay) end end)


--== CONFIG PAGE LOGIC ==--
local StatusLabel = create("TextLabel", { Parent = ConfigPage, LayoutOrder = 0, Size = UDim2.new(1, 0, 0, 20), BackgroundTransparency = 1, Text = "Current Config: " .. Config.ConfigName, TextColor3 = C_GREEN, Font = Enum.Font.Code, TextSize = 12 })
local AutoLoadLabel = create("TextLabel", { Parent = ConfigPage, LayoutOrder = 1, Size = UDim2.new(1, 0, 0, 20), BackgroundTransparency = 1, Text = "Auto-Load: " .. (Settings.AutoLoadEnabled and Settings.AutoLoadConfigName or "Disabled"), TextColor3 = C_BLUE, Font = Enum.Font.Code, TextSize = 12 })

local function updateInfo()
    StatusLabel.Text = "Current Config: " .. Config.ConfigName
    AutoLoadLabel.Text = "Auto-Load: " .. (Settings.AutoLoadEnabled and Settings.AutoLoadConfigName or "Disabled")
    -- Update farm UI elements when config is loaded
    RangeInput.Text = tostring(Config.FarmRange)
    updateFarmButtons()
end

local NameInput = create("TextBox", { Parent = ConfigPage, LayoutOrder = 2, Size = UDim2.new(1, 0, 0, 36), BackgroundColor3 = C_MAIN, PlaceholderText = "Enter config name...", Text = "", TextColor3 = C_TEXT, Font = Enum.Font.Gotham, TextSize = 13 }, { create("UICorner", {CornerRadius = UDim.new(0, 6)}), create("UIStroke", {Color = C_ACCENT}) })
local SaveBtn = create("TextButton", { Parent = ConfigPage, LayoutOrder = 3, Size = UDim2.new(1, 0, 0, 36), BackgroundColor3 = C_ACCENT, Text = "Save Current Settings", Font = Enum.Font.GothamBold, TextColor3 = C_TEXT, TextSize = 13 }, { create("UICorner", {CornerRadius = UDim.new(0, 6)}) })
local ConfigListFrame = create("Frame", { Parent = ConfigPage, LayoutOrder = 5, Size = UDim2.new(1, 0, 0, 0), BackgroundTransparency = 1, AutomaticSize = Enum.AutomaticSize.Y })
local RefreshBtn = create("TextButton", { Parent = ConfigPage, LayoutOrder = 4, Size = UDim2.new(1, 0, 0, 24), BackgroundTransparency = 1, Text = "Refresh Config List", TextColor3 = C_TEXT_DIM, Font = Enum.Font.Gotham, TextSize = 12 })

local function refreshConfigList()
    ConfigListFrame:ClearAllChildren()
    create("UIListLayout", { Parent = ConfigListFrame, SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0, 4) })
    for _, fname in ipairs(listConfigs()) do
        local row = create("Frame", { Parent = ConfigListFrame, Size = UDim2.new(1, 0, 0, 30), BackgroundColor3 = C_MAIN }, { create("UICorner", {CornerRadius = UDim.new(0, 4)}) })
        local loadB = create("TextButton", { Parent = row, Size = UDim2.new(1, -120, 1, 0), BackgroundTransparency = 1, Text = "  " .. fname, TextXAlignment = Enum.TextXAlignment.Left, TextColor3 = C_TEXT, Font = Enum.Font.Gotham, TextSize = 13 })
        loadB.MouseButton1Click:Connect(function() if loadConfig(fname) then updateInfo(); NameInput.Text = fname; DelayInput.Text = tostring(Config.AutoBuyDelay); updateMasterToggle() end end)
        local mainB = create("TextButton", { Parent = row, Size = UDim2.new(0, 60, 1, 0), Position = UDim2.new(1, -90, 0, 0), BackgroundColor3 = C_BLUE, Text = "Main", TextColor3 = C_TEXT, Font = Enum.Font.GothamBold, TextSize = 10 })
        mainB.MouseButton1Click:Connect(function() Settings.AutoLoadConfigName = fname; Settings.AutoLoadEnabled = true; saveMainSettings(); updateInfo() end)
        local delB = create("TextButton", { Parent = row, Size = UDim2.new(0, 30, 1, 0), Position = UDim2.new(1, -30, 0, 0), BackgroundColor3 = C_RED, Text = "X", TextColor3 = C_TEXT, Font = Enum.Font.GothamBold, TextSize = 12 })
        delB.MouseButton1Click:Connect(function() deleteConfig(fname); refreshConfigList() end)
    end
end
SaveBtn.MouseButton1Click:Connect(function() local n = NameInput.Text; if n == "" then n = Config.ConfigName end; saveConfig(n); updateInfo(); task.wait(0.1); refreshConfigList() end)
RefreshBtn.MouseButton1Click:Connect(refreshConfigList)
refreshConfigList()
updateInfo()

--== MAIN LOOPS ==--

-- Merchant Auto-Buy Loop
task.spawn(function()
    while ScreenGui.Parent do
        if Config.AutoBuyEnabled then
            for key, enabled in pairs(Config.SelectedItems) do
                if enabled and Config.AutoBuyEnabled then
                    pcall(function() PurchaseRemote:InvokeServer(key, 1) end)
                end
            end
            task.wait(Config.AutoBuyDelay)
        else
            task.wait(0.2)
        end
    end
end)

-- Advanced Farming Loop (Single & Group)
task.spawn(function()
    -- Safely grab game modules
    local PlayerScripts = LocalPlayer:WaitForChild("PlayerScripts")
    local Source = PlayerScripts:WaitForChild("Source")
    local WorldManager = require(Source:WaitForChild("ClientWorldManager"))
    local ClientPlayerManager = require(Source:WaitForChild("ClientPlayerManager"))
    local EventHandler = require(ReplicatedStorage.Common.EventHandler)
    
    local HighPriority = {"chest", "petball", "super_candy", "crystal"}
    local RaresList = {"crystal", "super_candy"} -- Objects to ignore if checkbox is checked
    
    -- Filter Lists
    local TargetCoins = {"coin", "pile", "diamond"}
    local TargetBushes = {"bush", "tree", "flower", "plant", "shrub", "mushroom"}
    local EventKeywords = {"16_thistling", "15_shooba", "18_stegrump"}
    local BossKeyword = "20_ice1"

    print(">> Farming Logic Loaded")
    
    while ScreenGui.Parent do
        task.wait(0.2)
        local Character = LocalPlayer.Character
        local Root = Character and Character:FindFirstChild("HumanoidRootPart")
        
        -- === FARM 1: SINGLE FARM (PACKET) ===
        if Config.Farm1Enabled and Root then
            -- 1. GET FREE PETS
            local MyData = ClientPlayerManager:get_player_data(LocalPlayer)
            local FreePets = {}
            if MyData and MyData.entities then
                for id, pet in pairs(MyData.entities) do
                    if pet.task == "idle" then
                        table.insert(FreePets, id)
                    end
                end
            end
            
            if #FreePets > 0 then
                local MyPos = Root.Position
                local Chests = {}
                local Bosses = {}
                local Others = {}
                local Range = Config.FarmRange or 300
                
                -- Filters
                local CoinsOnly = Config.FarmCoinsEnabled
                local BushesOnly = Config.FarmBushesEnabled

                -- 2. SCAN & SORT
                for id, farmeable in pairs(WorldManager.farmeables) do
                    if farmeable and farmeable.position then
                        local Dist = (farmeable.position - MyPos).Magnitude
                        if Dist < Range then
                            local Type = "unknown"
                            if farmeable.render then
                                if typeof(farmeable.render.instance) == "Instance" then Type = farmeable.render.instance.Name
                                elseif type(farmeable.render.instance) == "string" then Type = farmeable.render.instance
                                elseif type(farmeable.render.name) == "string" then Type = farmeable.render.name end
                            end
                            Type = string.lower(Type)
                            
                            local Valid = true
                            -- CHECK 1: IGNORE RARES
                            if Config.IgnoreRares then
                                for _, k in pairs(RaresList) do
                                    if string.find(Type, k) then Valid = false; break end
                                end
                            end
                            
                            -- CHECK 2: FILTERS
                            if Valid then
                                if Config.EventNPCEnabled then
                                    Valid = false
                                    -- Deep Scan for Child Names (Fix for Random Number Models)
                                    local isBoss = false
                                    local Model = workspace.Farmeables:FindFirstChild(tostring(id))
                                    if Model then
                                        for _, child in pairs(Model:GetChildren()) do
                                            local cName = string.lower(child.Name)
                                            for _, kw in pairs(EventKeywords) do
                                                if string.find(cName, kw) then Valid = true; break end
                                            end
                                            if Config.EventBossEnabled and string.find(cName, BossKeyword) then Valid = true; isBoss = true end
                                            if Valid then break end
                                        end
                                    end
                                elseif CoinsOnly then
                                    Valid = false
                                    for _, k in pairs(TargetCoins) do if string.find(Type, k) then Valid = true; break end end
                                    if not Valid then
                                        for _, k in pairs(HighPriority) do if string.find(Type, k) then Valid = true; break end end
                                    end
                                elseif BushesOnly then
                                    Valid = false
                                    for _, k in pairs(TargetBushes) do if string.find(Type, k) then Valid = true; break end end
                                end
                            end
                            
                            if Valid then
                                local Data = {id=id, dist=Dist}
                                local IsPriority = false
                                
                                -- FIX: DO NOT force priority for Event NPCs in Single Farm. 
                                -- We want them to fall into 'Others' so they get distributed 1 pet per NPC.
                                
                                -- Only prioritize (group up) if GroupChests is ON
                                if Config.GroupChests and not BushesOnly and not Config.EventNPCEnabled then
                                    for _, k in pairs(HighPriority) do
                                        if string.find(Type, k) then IsPriority = true; break end
                                    end
                                end
                                
                                if isBoss then table.insert(Bosses, Data) elseif IsPriority then table.insert(Chests, Data) else table.insert(Others, Data) end
                            end
                        end
                    end
                end
                
                table.sort(Chests, function(a,b) return a.dist < b.dist end)
                table.sort(Others, function(a,b) return a.dist < b.dist end)
                
                -- 3. ASSIGN TASKS
                local Tasks = {}
                local AvailablePets = {unpack(FreePets)}
                if #Bosses > 0 and #AvailablePets > 0 then
                     table.sort(Bosses, function(a,b) return a.dist < b.dist end)
                     local bossTarget = Bosses[1].id; local petID = table.remove(AvailablePets, 1)
                     Tasks[petID] = { ["task"] = "farm", ["target_id"] = bossTarget }
                end
                if #Chests > 0 and #AvailablePets > 0 then
                    local Target = Chests[1].id
                    for _, petID in pairs(AvailablePets) do
                        Tasks[petID] = { ["task"] = "farm", ["target_id"] = Target }
                    end
                else
                    local CoinIndex = 1
                    for _, petID in pairs(AvailablePets) do
                        if Others[CoinIndex] then
                            local Target = Others[CoinIndex].id
                            Tasks[petID] = { ["task"] = "farm", ["target_id"] = Target }
                            CoinIndex = CoinIndex + 1
                        else break end
                    end
                end
                
                -- 4. SEND PACKET
                if next(Tasks) then
                    EventHandler:send("SET_PETS_TASKS", Tasks)
                end
            end
            
        -- === FARM 2: GROUP FARM (WOLF PACK) ===
        elseif Config.Farm2Enabled and Root then
            if WorldManager:count_free_pets() > 0 then
                local MyPos = Root.Position
                local Range = Config.FarmRange or 300
                
                local BestPriorityID = nil
                local BestPriorityDist = Range
                local BestFillerID = nil
                local BestFillerDist = Range
                
                -- Filters
                local CoinsOnly = Config.FarmCoinsEnabled
                local BushesOnly = Config.FarmBushesEnabled
                
                for id, farmeable in pairs(WorldManager.farmeables) do
                    if farmeable and farmeable.position then
                        local Dist = (farmeable.position - MyPos).Magnitude
                        if Dist < Range then
                            local Type = "unknown"
                            if farmeable.render then
                                if typeof(farmeable.render.instance) == "Instance" then Type = farmeable.render.instance.Name
                                elseif type(farmeable.render.instance) == "string" then Type = farmeable.render.instance
                                elseif type(farmeable.render.name) == "string" then Type = farmeable.render.name end
                            end
                            Type = string.lower(Type)
                            
                            -- FILTER CHECK
                            local Valid = true
                            -- CHECK 1: IGNORE RARES
                            if Config.IgnoreRares then
                                for _, k in pairs(RaresList) do
                                    if string.find(Type, k) then Valid = false; break end
                                end
                            end
                            
                            if Valid then
                                if Config.EventNPCEnabled then
                                    Valid = false
                                    local isBoss = false
                                    local Model = workspace.Farmeables:FindFirstChild(tostring(id))
                                    if Model then
                                        for _, child in pairs(Model:GetChildren()) do
                                            local cName = string.lower(child.Name)
                                            for _, kw in pairs(EventKeywords) do
                                                if string.find(cName, kw) then Valid = true; break end
                                            end
                                            if Config.EventBossEnabled and string.find(cName, BossKeyword) then Valid = true; isBoss = true end
                                            if Valid then break end
                                        end
                                    end
                                elseif CoinsOnly then
                                    Valid = false
                                    for _, k in pairs(TargetCoins) do if string.find(Type, k) then Valid = true; break end end
                                    -- Allow priority items in Coin mode (like Farm1)
                                    if not Valid then
                                        for _, k in pairs(HighPriority) do if string.find(Type, k) then Valid = true; break end end
                                    end
                                elseif BushesOnly then
                                    Valid = false
                                    for _, k in pairs(TargetBushes) do if string.find(Type, k) then Valid = true; break end end
                                end
                            end
                            
                            if Valid then
                                local IsPriority = false
                                if Config.EventNPCEnabled then IsPriority = true end
                                -- Check GroupChests setting for priority
                                if Config.GroupChests and not BushesOnly then
                                    for _, k in pairs(HighPriority) do
                                        if string.find(Type, k) then IsPriority = true; break end
                                    end
                                end
                                
                                if IsPriority then
                                    if Dist < BestPriorityDist then
                                        BestPriorityDist = Dist
                                        BestPriorityID = id
                                    end
                                else
                                    if Dist < BestFillerDist then
                                        BestFillerDist = Dist
                                        BestFillerID = id
                                    end
                                end
                            end
                        end
                    end
                end

                local FinalTarget = BestPriorityID or BestFillerID
                if FinalTarget then
                    WorldManager:send_farm(FinalTarget, false)
                end
            end
        end
    end
end)

-- [[ SPEED MULTIPLIER LOOP (20x) ]] --
task.spawn(function()
    local Players = game:GetService("Players")
    local ClientPlayerManager = require(Players.LocalPlayer.PlayerScripts.Source.ClientPlayerManager)

    while task.wait(0.1) do -- Check every 0.1s
        local myData = ClientPlayerManager:get_player_data(Players.LocalPlayer)

        if myData and myData.entities then
            if Config and Config.FastPets then
                -- TOGGLE IS ON: Force speed to 2
                for id, pet in pairs(myData.entities) do
                    if pet.speed_multiplier ~= 20 then
                        pet.speed_multiplier = 20 -- 20x Speed!
                    end
                end
            else
                -- TOGGLE IS OFF: Force speed back to 1 (Normal Speed)
                for id, pet in pairs(myData.entities) do
                    if pet.speed_multiplier ~= 1 then
                        pet.speed_multiplier = 1 -- Reset speed
                    end
                end
            end
        end
    end
end)
